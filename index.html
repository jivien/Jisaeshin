import React, { useState, useMemo } from 'react';
import { Search, ShoppingCart, ArrowLeft, X, ChevronLeft, ChevronRight, Video, MessageCircle, User, MapPin, Phone, CreditCard, Banknote, Wallet, Package } from 'lucide-react';

// --- DATA PRODUK (LEBIH LENGKAP) ---
// Data sekarang mencakup beberapa gambar dan ID video YouTube
const initialProducts = [
  {
    id: 1,
    name: 'Kamera Mirrorless ProX',
    description: 'Kamera mirrorless profesional dengan sensor full-frame 45MP. Mampu merekam video 8K. Cocok untuk fotografer dan videografer profesional yang menuntut kualitas tertinggi.',
    price: 32500000,
    images: [
      'https://placehold.co/600x600/1a1a1a/ffffff?text=Kamera+Depan',
      'https://placehold.co/600x600/1a1a1a/ffffff?text=Kamera+Samping',
      'https://placehold.co/600x600/1a1a1a/ffffff?text=Kamera+Belakang',
      'https://placehold.co/600x600/1a1a1a/ffffff?text=Lensa+Kit'
    ],
    videoYoutubeId: 'l_a59h8a-0k' // Contoh ID video YouTube
  },
  {
    id: 2,
    name: 'Drone DJI Air 3',
    description: 'Drone lipat dengan kamera ganda, sensor 1/1.3-inch CMOS, dan kemampuan merekam video 4K/100fps. Waktu terbang maksimal 46 menit.',
    price: 17800000,
    images: [
      'https://placehold.co/600x600/2a2a2a/ffffff?text=Drone+Terbang',
      'https://placehold.co/600x600/2a2a2a/ffffff?text=Drone+Terlipat',
      'https://placehold.co/600x600/2a2a2a/ffffff?text=Remote+Control'
    ],
    videoYoutubeId: 'r_T-nC2wR9c'
  },
  {
    id: 3,
    name: 'Laptop Gaming ROG Strix',
    description: 'Ditenagai oleh prosesor Intel Core i9 Generasi ke-13 dan GPU NVIDIA GeForce RTX 4080. Layar QHD 240Hz untuk pengalaman gaming yang imersif.',
    price: 45999000,
    images: [
      'https://placehold.co/600x600/1c1c1c/ffffff?text=Laptop+Depan',
      'https://placehold.co/600x600/1c1c1c/ffffff?text=Keyboard+RGB',
      'https://placehold.co/600x600/1c1c1c/ffffff?text=Port+Samping'
    ],
    videoYoutubeId: 'AbkUda2m6_0'
  },
  {
    id: 4,
    name: 'Sepatu Lari Ultraboost',
    description: 'Sepatu lari dengan teknologi bantalan Boost yang responsif, memberikan kenyamanan maksimal untuk lari jarak jauh maupun penggunaan sehari-hari.',
    price: 2800000,
    images: [
      'https://placehold.co/600x600/2b2b2b/ffffff?text=Sepatu+Samping',
      'https://placehold.co/600x600/2b2b2b/ffffff?text=Sepatu+Atas',
      'https://placehold.co/600x600/2b2b2b/ffffff?text=Sol+Sepatu'
    ],
    videoYoutubeId: null
  },
    {
    id: 5,
    name: 'Smartwatch Titan Pro',
    description: 'Smartwatch tangguh dengan GPS, monitor detak jantung, SpO2, dan lebih dari 100 mode olahraga. Baterai tahan hingga 14 hari.',
    price: 3500000,
    images: [
      'https://placehold.co/600x600/3a3a3a/ffffff?text=Watch+Face',
      'https://placehold.co/600x600/3a3a3a/ffffff?text=Watch+Samping'
    ],
    videoYoutubeId: null
  },
  {
    id: 6,
    name: 'Mechanical Keyboard K8 Pro',
    description: 'Keyboard mekanikal nirkabel dengan layout TKL. Switch Gateron Pro yang sudah di-lubed, PBT keycaps, dan hot-swappable.',
    price: 1650000,
    images: [
      'https://placehold.co/600x600/1e1e1e/ffffff?text=Keyboard+Atas',
      'https://placehold.co/600x600/1e1e1e/ffffff?text=Detail+Switch',
      'https://placehold.co/600x600/1e1e1e/ffffff?text=Lampu+RGB'
    ],
    videoYoutubeId: 'kUy31G36d24'
  },
];

// --- Helper Functions & Components ---
const formatCurrency = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);

const ProductCard = ({ product, onProductSelect }) => (
  <div onClick={() => onProductSelect(product)} className="bg-slate-800 rounded-lg shadow-lg overflow-hidden transition-transform transform hover:scale-105 cursor-pointer flex flex-col group">
    <img src={product.images[0]} alt={product.name} className="w-full h-48 object-cover" />
    <div className="p-4 flex flex-col flex-grow">
      <h3 className="text-md font-bold text-white mb-2 truncate group-hover:whitespace-normal">{product.name}</h3>
      <div className="mt-auto">
         <p className="text-lg font-semibold text-cyan-400">{formatCurrency(product.price)}</p>
      </div>
    </div>
  </div>
);

// --- MAIN APPLICATION COMPONENT ---
export default function App() {
  const [products] = useState(initialProducts);
  const [cart, setCart] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [currentView, setCurrentView] = useState('catalog'); // catalog, productDetail, cart, checkout
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [address, setAddress] = useState({ name: '', street: '', phone: '' });
  const [paymentMethod, setPaymentMethod] = useState('bank_transfer');

  const handleProductSelect = (product) => {
    setSelectedProduct(product);
    setCurrentView('productDetail');
  };

  const handleAddToCart = (product, quantity = 1) => {
    setCart((prevCart) => {
      const existingItem = prevCart.find(item => item.id === product.id);
      if (existingItem) {
        return prevCart.map(item => item.id === product.id ? { ...item, quantity: item.quantity + quantity } : item);
      }
      return [...prevCart, { ...product, quantity }];
    });
    alert(${product.name} telah ditambahkan ke keranjang!);
  };

  const handleUpdateCartQuantity = (productId, amount) => {
    setCart(prevCart => prevCart.map(item => {
        if (item.id === productId) {
          const newQuantity = item.quantity + amount;
          return newQuantity > 0 ? { ...item, quantity: newQuantity } : null;
        }
        return item;
      }).filter(Boolean)
    );
  };
    
  const handleRemoveFromCart = (productId) => {
    setCart(cart => cart.filter(item => item.id !== productId));
  };

  const handlePlaceOrder = (e) => {
    e.preventDefault();
    if(cart.length === 0) {
        alert("Keranjang Anda kosong!");
        return;
    }
    if (!address.name || !address.street || !address.phone) {
        alert("Harap isi semua detail alamat pengiriman.");
        return;
    }

    console.log("Order Placed:", {
        address,
        paymentMethod,
        items: cart,
        total: totalCost
    });
    
    alert(Pesanan berhasil dibuat! \nTotal: ${formatCurrency(totalCost)} \nMetode Pembayaran: ${paymentMethod.replace('_', ' ').toUpperCase()});
    
    setCart([]);
    setCurrentView('catalog');
  };

  const filteredProducts = useMemo(() => 
    products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase())),
    [products, searchQuery]
  );
  
  const totalCost = useMemo(() => cart.reduce((sum, item) => sum + item.price * item.quantity, 0), [cart]);
  const totalItemsInCart = useMemo(() => cart.reduce((sum, item) => sum + item.quantity, 0), [cart]);

  // --- Render Logic ---
  const renderHeader = () => (
    <header className="bg-slate-800/70 backdrop-blur-sm sticky top-0 z-20 border-b border-slate-700">
      <div className="container mx-auto px-4 py-3 flex items-center gap-4">
        {currentView !== 'catalog' && (
          <button onClick={() => setCurrentView(currentView === 'productDetail' ? 'catalog' : 'cart')} className="text-white p-2 rounded-full hover:bg-slate-700">
            <ArrowLeft size={24} />
          </button>
        )}
        <div className="flex-grow relative">
          <Search size={20} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
          <input
            type="text"
            placeholder="Cari produk..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            onFocus={() => setCurrentView('catalog')}
            className="w-full bg-slate-700 border border-slate-600 rounded-lg py-2 pl-10 pr-4 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500"
          />
        </div>
        <button onClick={() => setCurrentView('cart')} className="relative text-white p-2 rounded-full hover:bg-slate-700">
          <ShoppingCart size={24} />
          {totalItemsInCart > 0 && (
            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">{totalItemsInCart}</span>
          )}
        </button>
      </div>
    </header>
  );

  const renderCatalog = () => (
    <div className="p-4">
      <h2 className="text-2xl font-bold mb-6 text-white">Jelajahi Produk Kami</h2>
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
        {filteredProducts.map(p => <ProductCard key={p.id} product={p} onProductSelect={handleProductSelect} />)}
      </div>
       {filteredProducts.length === 0 && <p className="text-slate-400 text-center py-10">Produk tidak ditemukan.</p>}
    </div>
  );

  const ProductDetailView = () => {
    const [currentImageIndex, setCurrentImageIndex] = useState(0);
    const [showVideo, setShowVideo] = useState(false);

    if (!selectedProduct) return null;

    const nextImage = () => setCurrentImageIndex((prev) => (prev + 1) % selectedProduct.images.length);
    const prevImage = () => setCurrentImageIndex((prev) => (prev - 1 + selectedProduct.images.length) % selectedProduct.images.length);

    return (
      <div className="p-4">
        <div className="max-w-4xl mx-auto bg-slate-800 rounded-lg shadow-xl overflow-hidden">
          <div className="md:flex">
             {/* Image & Video Viewer */}
            <div className="md:w-1/2">
                <div className="relative aspect-square bg-black">
                    {showVideo && selectedProduct.videoYoutubeId ? (
                        <iframe
                            className="w-full h-full"
                            src={https://www.youtube.com/embed/${selectedProduct.videoYoutubeId}?autoplay=1&rel=0}
                            title="YouTube video player"
                            frameBorder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowFullScreen>
                        </iframe>
                    ) : (
                        <>
                            <img src={selectedProduct.images[currentImageIndex]} alt="Product" className="w-full h-full object-cover"/>
                            {selectedProduct.images.length > 1 &&
                                <>
                                <button onClick={prevImage} className="absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/80"><ChevronLeft/></button>
                                <button onClick={nextImage} className="absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/80"><ChevronRight/></button>
                                </>
                            }
                        </>
                    )}
                </div>
                 <div className="flex p-2 bg-slate-900 overflow-x-auto">
                    {selectedProduct.images.map((img, index) => (
                        <img key={index} src={img} onClick={() => { setCurrentImageIndex(index); setShowVideo(false); }} className={w-16 h-16 object-cover rounded-md mr-2 cursor-pointer border-2 ${currentImageIndex === index && !showVideo ? 'border-cyan-500' : 'border-transparent'}}/>
                    ))}
                    {selectedProduct.videoYoutubeId && (
                         <div onClick={() => setShowVideo(true)} className={w-16 h-16 rounded-md mr-2 cursor-pointer border-2 flex items-center justify-center bg-slate-700 ${showVideo ? 'border-cyan-500' : 'border-transparent'}}>
                             <Video size={32} className="text-white"/>
                         </div>
                    )}
                </div>
            </div>
            {/* Product Info */}
            <div className="md:w-1/2 p-6 flex flex-col">
              <h2 className="text-3xl font-bold text-white mb-2">{selectedProduct.name}</h2>
              <p className="text-3xl font-bold text-cyan-400 mb-4">{formatCurrency(selectedProduct.price)}</p>
              <p className="text-slate-300 mb-6 flex-grow">{selectedProduct.description}</p>
              <button onClick={() => handleAddToCart(selectedProduct)} className="w-full bg-cyan-600 text-white font-bold py-3 rounded-lg hover:bg-cyan-700 transition-colors flex items-center justify-center gap-2">
                <ShoppingCart size={20}/> Tambah ke Keranjang
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };
    
  const CartView = () => (
    <div className="p-4 max-w-2xl mx-auto">
        <h2 className="text-2xl font-bold mb-6 text-white">Keranjang Saya</h2>
        {cart.length === 0 ? (
            <div className="text-center py-12 bg-slate-800 rounded-lg">
                <p className="text-slate-400">Keranjang Anda kosong.</p>
                <button onClick={() => setCurrentView('catalog')} className="mt-4 bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700">Mulai Belanja</button>
            </div>
        ) : (
            <div className="bg-slate-800 rounded-lg shadow-lg p-6">
                <div className="space-y-4">
                    {cart.map(item => (
                        <div key={item.id} className="flex items-center gap-4 border-b border-slate-700 pb-4">
                            <img src={item.images[0]} alt={item.name} className="w-20 h-20 rounded-md object-cover"/>
                            <div className="flex-grow">
                                <p className="font-bold text-white">{item.name}</p>
                                <p className="text-sm text-cyan-400">{formatCurrency(item.price)}</p>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => handleUpdateCartQuantity(item.id, -1)} className="p-1.5 rounded-full bg-slate-700 hover:bg-slate-600">-</button>
                                <span className="w-8 text-center font-bold">{item.quantity}</span>
                                <button onClick={() => handleUpdateCartQuantity(item.id, 1)} className="p-1.5 rounded-full bg-slate-700 hover:bg-slate-600">+</button>
                            </div>
                            <button onClick={() => handleRemoveFromCart(item.id)} className="text-red-500 hover:text-red-400"><X size={20}/></button>
                        </div>
                    ))}
                </div>
                <div className="mt-6">
                    <div className="flex justify-between text-xl font-bold">
                        <span>Total:</span>
                        <span>{formatCurrency(totalCost)}</span>
                    </div>
                    <button onClick={() => setCurrentView('checkout')} className="w-full mt-4 bg-cyan-600 text-white font-bold py-3 rounded-lg hover:bg-cyan-700">
                        Checkout
                    </button>
                </div>
            </div>
        )}
    </div>
  );
    
  const CheckoutView = () => (
    <form onSubmit={handlePlaceOrder} className="p-4 max-w-4xl mx-auto">
        <h2 className="text-2xl font-bold mb-6 text-white">Checkout</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            {/* Address & Payment */}
            <div>
                {/* Alamat Pengiriman */}
                <div className="bg-slate-800 p-6 rounded-lg mb-6">
                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><MapPin size={20} className="text-cyan-400"/> Alamat Pengiriman</h3>
                    <div className="space-y-4">
                        <div className="relative">
                           <User className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/>
                           <input type="text" placeholder="Nama Penerima" value={address.name} onChange={e => setAddress({...address, name: e.target.value})} className="w-full bg-slate-700 rounded-md py-2 pl-10 pr-3" required />
                        </div>
                        <div className="relative">
                           <MapPin className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/>
                           <input type="text" placeholder="Alamat Lengkap" value={address.street} onChange={e => setAddress({...address, street: e.target.value})} className="w-full bg-slate-700 rounded-md py-2 pl-10 pr-3" required />
                        </div>
                        <div className="relative">
                           <Phone className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/>
                           <input type="tel" placeholder="Nomor Telepon" value={address.phone} onChange={e => setAddress({...address, phone: e.target.value})} className="w-full bg-slate-700 rounded-md py-2 pl-10 pr-3" required />
                        </div>
                    </div>
                </div>

                {/* Metode Pembayaran */}
                <div className="bg-slate-800 p-6 rounded-lg">
                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><CreditCard size={20} className="text-cyan-400"/> Metode Pembayaran</h3>
                    <div className="space-y-3">
                        {['bank_transfer', 'credit_card', 'e_wallet'].map(method => (
                             <label key={method} className="flex items-center gap-3 p-3 bg-slate-700 rounded-lg cursor-pointer has-[:checked]:bg-cyan-900/50 has-[:checked]:ring-2 has-[:checked]:ring-cyan-500">
                                <input type="radio" name="payment" value={method} checked={paymentMethod === method} onChange={e => setPaymentMethod(e.target.value)} className="w-4 h-4 accent-cyan-500"/>
                                <span className="capitalize font-semibold">{method.replace('_', ' ')}</span>
                                {method === 'bank_transfer' && <Banknote className="ml-auto text-slate-400"/>}
                                {method === 'credit_card' && <CreditCard className="ml-auto text-slate-400"/>}
                                {method === 'e_wallet' && <Wallet className="ml-auto text-slate-400"/>}
                             </label>
                        ))}
                    </div>
                </div>
            </div>

            {/* Ringkasan Pesanan */}
            <div className="bg-slate-800 p-6 rounded-lg h-fit">
                <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Package size={20} className="text-cyan-400"/> Ringkasan Pesanan</h3>
                 <div className="space-y-2 max-h-64 overflow-y-auto pr-2 mb-4">
                    {cart.map(item => (
                        <div key={item.id} className="flex justify-between items-start gap-2">
                           <span className="text-slate-300">{item.name} <span className="text-xs">x{item.quantity}</span></span>
                           <span className="font-semibold text-right whitespace-nowrap">{formatCurrency(item.price * item.quantity)}</span>
                        </div>
                    ))}
                </div>
                <div className="border-t border-slate-700 pt-4 mt-4 space-y-2">
                    <div className="flex justify-between font-bold text-lg">
                        <span>Total</span>
                        <span>{formatCurrency(totalCost)}</span>
                    </div>
                </div>
                <button type="submit" className="w-full mt-6 bg-cyan-600 text-white font-bold py-3 rounded-lg hover:bg-cyan-700">
                    Buat Pesanan
                </button>
            </div>
        </div>
    </form>
  );

  return (
    <div className="bg-slate-900 min-h-screen text-white font-sans">
      {renderHeader()}
      <main className="container mx-auto">
        {currentView === 'catalog' && renderCatalog()}
        {currentView === 'productDetail' && <ProductDetailView />}
        {currentView === 'cart' && <CartView />}
        {currentView === 'checkout' && <CheckoutView />}
      </main>
      {/* Tombol Hubungi Admin */}
      <a href="mailto:admin@tokosaya.com" className="fixed bottom-6 right-6 bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition-colors flex items-center gap-2">
        <MessageCircle size={24}/>
      </a>
    </div>
  );
}
